{% extends "base.html" %}

{% block title %}University Food Ordering - Menu{% endblock %}

{% block extra_css %}
<style>
    body { padding-top: 60px; }
    .menu-header {
        background-color: var(--bs-dark);
        padding: 3rem 0;
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Menu Header -->
<div class="menu-header">
    <div class="container">
        <h1 class="display-5 fw-bold">Campus Food Menu</h1>
        <p class="lead">Browse and order from our selection of university cafeteria items</p>
    </div>
</div>

<!-- Menu Filters -->
<div class="container mb-5">
    <div class="filter-section">
        <h4 class="mb-3">Filter Options</h4>
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="categoryFilter" class="form-label">Food Category</label>
                <select id="categoryFilter" class="form-select">
                    <option value="all">All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category }}">{{ category }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-4 mb-3">
                <label for="locationFilter" class="form-label">Location</label>
                <select id="locationFilter" class="form-select">
                    <option value="all">All Locations</option>
                    <option value="Main Cafeteria">Main Cafeteria</option>
                    <option value="Science Building">Science Building</option>
                    <option value="Student Center">Student Center</option>
                </select>
            </div>
            
            <div class="col-md-4 mb-3 d-flex align-items-end">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="vegetarianFilter">
                    <label class="form-check-label" for="vegetarianFilter">
                        Vegetarian Options Only <i class="fas fa-leaf text-success ms-1"></i>
                    </label>
                </div>
            </div>
        </div>
    </div>
    
    <!-- No Results Message -->
    <div id="noResultsMessage" class="alert alert-info text-center my-5 d-none">
        <i class="fas fa-info-circle me-2"></i> No menu items match your current filter criteria. Try adjusting your filters.
    </div>
    
    <!-- Menu Items Container -->
    <div class="row" id="menuItemsContainer">
        <!-- Menu items will be loaded dynamically via JavaScript -->
    </div>
    
    <!-- Back to Top Button -->
    <button id="backToTopBtn" class="btn btn-primary position-fixed bottom-0 end-0 m-4 d-none">
        <i class="fas fa-arrow-up"></i>
    </button>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filter elements
    const categoryFilter = document.getElementById('categoryFilter');
    const locationFilter = document.getElementById('locationFilter');
    const vegetarianFilter = document.getElementById('vegetarianFilter');
    const menuItemsContainer = document.getElementById('menuItemsContainer');
    const noResultsMessage = document.getElementById('noResultsMessage');
    const backToTopBtn = document.getElementById('backToTopBtn');
    
    // Show loading state
    function showLoading() {
        menuItemsContainer.innerHTML = `
            <div class="col-12 text-center my-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading menu items...</p>
            </div>
        `;
    }
    
    // Apply filters and update menu items
    function applyFilters() {
        showLoading();
        
        // Get filter values
        const category = categoryFilter.value;
        const location = locationFilter.value;
        const isVegetarian = vegetarianFilter.checked;
        
        // Build query string
        let queryParams = new URLSearchParams();
        if (category !== 'all') queryParams.append('category', category);
        if (location !== 'all') queryParams.append('location', location);
        if (isVegetarian) queryParams.append('vegetarian', 'true');
        
        // Fetch filtered menu items
        fetch(`/api/menu/filter?${queryParams.toString()}`)
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => displayMenuItems(data))
            .catch(error => {
                console.error('Error fetching menu items:', error);
                menuItemsContainer.innerHTML = `
                    <div class="col-12 text-center my-5">
                        <div class="alert alert-danger" role="alert">
                            Error loading menu items. Please try again later.
                        </div>
                    </div>
                `;
            });
    }
    
    // Display menu items
    function displayMenuItems(items) {
        menuItemsContainer.innerHTML = '';
        
        if (items.length === 0) {
            noResultsMessage.classList.remove('d-none');
        } else {
            noResultsMessage.classList.add('d-none');
            
            items.forEach(item => {
                const formattedPrice = parseFloat(item.price).toFixed(2);
                const imageUrl = item.image_url || '/static/images/default-food.svg';
                
                const menuItemCard = document.createElement('div');
                menuItemCard.className = 'col-md-6 col-lg-4 mb-4';
                menuItemCard.innerHTML = `
                    <div class="card menu-item-card h-100">
                        ${item.promotion ? `<div class="promotion-tag badge bg-danger">${item.promotion}</div>` : ''}
                        ${item.is_vegetarian ? `<span class="vegetarian-badge badge bg-success" title="Vegetarian"><i class="fas fa-leaf"></i></span>` : ''}
                        <img src="${imageUrl}" class="card-img-top menu-item-img" alt="${item.name}">
                        <div class="card-body">
                            <h5 class="card-title">${item.name}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">${item.category}</h6>
                            <p class="card-text">${item.description}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <p class="card-text fw-bold mb-0">â‚¹${formattedPrice}</p>
                                <small class="text-muted">${item.location}</small>
                            </div>
                            ${item.is_available 
                                ? `<a href="/order" class="btn btn-primary mt-3 w-100">Order Now</a>` 
                                : `<button class="btn btn-secondary mt-3 w-100" disabled>Not Available</button>`
                            }
                        </div>
                    </div>
                `;
                menuItemsContainer.appendChild(menuItemCard);
            });
        }
    }
    
    // Event listeners for filters
    categoryFilter.addEventListener('change', applyFilters);
    locationFilter.addEventListener('change', applyFilters);
    vegetarianFilter.addEventListener('change', applyFilters);
    
    // Back to top button
    window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
            backToTopBtn.classList.remove('d-none');
        } else {
            backToTopBtn.classList.add('d-none');
        }
    });
    
    backToTopBtn.addEventListener('click', function() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    
    // Initial load
    applyFilters();
});
</script>
{% endblock %}